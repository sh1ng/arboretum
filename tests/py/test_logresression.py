import arboretum
import numpy as np
from sklearn.datasets import load_iris
import json
import pytest


def run_regression(depth, true_values, trees=1):
        # load test data
    iris = load_iris()
    n = 10000

    y = iris.target != 2

    data = arboretum.DMatrix(iris.data, y=y)

    config = json.dumps({'objective': 1,
                         'method': 0,
                         'tree':
                         {
                             'eta': 0.2,
                             'max_depth': depth,
                             'gamma': 0.0,
                             'min_child_weight': 2.0,
                             'min_leaf_size': 0,
                             'colsample_bytree': 1.0,
                             'colsample_bylevel': 1.0,
                             'lambda': 0.0,
                             'alpha': 0.0
                         }})

    model = arboretum.Garden(config, data)

    # grow trees
    for i in range(trees):
        model.grow_tree()

    # predict on train data set
    pred = model.predict(data)
    print(true_values)
    print(pred)
    assert np.allclose(pred, true_values)


def test_single_tree_depth_2(): run_regression(2, [0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.40549785, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.5894128,
                                                   0.5894128, 0.5894128, 0.5894128, 0.5894128, 0.40549785, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.5894128, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.5894128,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.5894128, 0.40549785, 0.40549785,
                                                   0.40549785, 0.5894128, 0.5894128, 0.40549785, 0.40549785, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785,
                                                   0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785, 0.40549785])


def test_single_tree_depth_3(): run_regression(3, [0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.5, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.42555746, 0.59668386,
                                                   0.5, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.5,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.5,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.59668386,
                                                   0.59668386, 0.59668386, 0.59668386, 0.59668386, 0.40131232, 0.42555746,
                                                   0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.59668386, 0.40131232,
                                                   0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.42555746,
                                                   0.42555746, 0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.5,
                                                   0.40131232, 0.42555746, 0.40131232, 0.40131232, 0.40131232, 0.40131232,
                                                   0.40131232, 0.40131232, 0.40131232, 0.5, 0.40131232, 0.40131232,
                                                   0.40131232, 0.5, 0.5, 0.40131232, 0.40131232, 0.40131232,
                                                   0.42555746, 0.40131232, 0.40131232, 0.40131232, 0.42555746, 0.40131232,
                                                   0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.40131232, 0.42555746])


def test_2trees_depth_2(): run_regression(2, [0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.5166032, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.48408338, 0.6638412,
                                              0.5166032, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.5166032,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.5166032,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.6638412,
                                              0.6638412, 0.6638412, 0.6638412, 0.6638412, 0.3367726, 0.3367726,
                                              0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.6638412, 0.3367726,
                                              0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726,
                                              0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.5166032,
                                              0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726,
                                              0.48408338, 0.3367726, 0.3367726, 0.5166032, 0.3367726, 0.3367726,
                                              0.3367726, 0.5166032, 0.5166032, 0.3367726, 0.3367726, 0.3367726,
                                              0.48408338, 0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726,
                                              0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726, 0.3367726], 2)


if __name__ == "__main__":
    test_single_tree_depth_3()
